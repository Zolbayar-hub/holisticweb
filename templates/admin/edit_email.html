{% extends "admin/base.html" %}

{% block title %}{{ 'Edit Email Template' if template else 'Create Email Template' }}{% endblock %}
{% block page_title %}{{ 'Edit Email Template' if template else 'Create New Email Template' }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-10 offset-md-1">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-envelope me-2"></i>
                    {{ 'Edit Email Template' if template else 'Create New Email Template' }}
                </h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="mb-3">
                        <label for="name" class="form-label">Template Name</label>
                        <input type="text" class="form-control" id="name" name="name" 
                               value="{{ template.name if template else '' }}" 
                               placeholder="e.g., booking_confirmation" required>
                        <div class="form-text">A unique identifier for this template (used internally).</div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <input type="text" class="form-control" id="description" name="description" 
                               value="{{ template.description if template else '' }}" 
                               placeholder="Brief description of when this template is used">
                    </div>

                    <div class="mb-3">
                        <label for="subject" class="form-label">Email Subject</label>
                        <input type="text" class="form-control" id="subject" name="subject" 
                               value="{{ template.subject if template else '' }}" 
                               placeholder="Your booking confirmation" required>
                        <div class="form-text">You can use variables like {user_name} and {service_name} in the subject.</div>
                    </div>

                    <div class="mb-3">
                        <label for="body" class="form-label">Email Body</label>
                        <textarea class="form-control" id="body" name="body" rows="15" required 
                                  placeholder="Dear {user_name},

Thank you for booking {service_name} with us!

Your appointment details:
- Service: {service_name}
- Price: ${service_price}
- Date & Time: {start_time} - {end_time}

We look forward to seeing you!

Best regards,
The Holistic Therapy Team">{{ template.body if template else '' }}</textarea>
                        <div class="form-text">Use the variables from the reference table below to personalize the email.</div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('web_admin_panel.admin_emails') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i>
                            Back to Templates
                        </a>
                        <div>
                            <button type="button" class="btn btn-outline-info me-2" onclick="previewEmail()">
                                <i class="fas fa-eye me-1"></i>
                                Preview
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>
                                {{ 'Update Template' if template else 'Create Template' }}
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Variable Reference -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Available Variables
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Customer Variables:</h6>
                        <ul class="small">
                            <li><code>{user_name}</code> - Customer's name</li>
                            <li><code>{email}</code> - Customer's email address</li>
                        </ul>
                        
                        <h6>Booking Variables:</h6>
                        <ul class="small">
                            <li><code>{service_name}</code> - Name of the booked service</li>
                            <li><code>{service_price}</code> - Price of the service</li>
                            <li><code>{start_time}</code> - Appointment start date/time</li>
                            <li><code>{end_time}</code> - Appointment end date/time</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Example Usage:</h6>
                        <div class="small">
                            <div class="bg-light p-2 rounded">
                                <strong>Subject:</strong> Booking Confirmation - {service_name}<br><br>
                                <strong>Body:</strong><br>
                                Dear {user_name},<br><br>
                                Your {service_name} appointment is confirmed!<br>
                                Date: {start_time}<br>
                                Price: ${service_price}<br><br>
                                See you soon!
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Email Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <strong>Subject:</strong>
                    <div id="previewSubject" class="border p-2 rounded bg-light"></div>
                </div>
                <div>
                    <strong>Body:</strong>
                    <div id="previewBody" class="border p-3 rounded bg-light" style="white-space: pre-wrap;"></div>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        This preview shows the template with sample data.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function previewEmail() {
    const subject = document.getElementById('subject').value;
    const body = document.getElementById('body').value;
    
    // Sample data for preview
    const sampleData = {
        '{user_name}': 'John Doe',
        '{email}': 'john.doe@example.com',
        '{service_name}': 'Holistic Therapy Session',
        '{service_price}': '99.99',
        '{start_time}': 'March 15, 2025 at 10:00 AM',
        '{end_time}': 'March 15, 2025 at 11:30 AM'
    };
    
    // Replace variables with sample data
    let previewSubject = subject;
    let previewBody = body;
    
    for (const [variable, value] of Object.entries(sampleData)) {
        previewSubject = previewSubject.replace(new RegExp(variable.replace(/[{}]/g, '\\$&'), 'g'), value);
        previewBody = previewBody.replace(new RegExp(variable.replace(/[{}]/g, '\\$&'), 'g'), value);
    }
    
    document.getElementById('previewSubject').textContent = previewSubject;
    document.getElementById('previewBody').textContent = previewBody;
    
    var previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
    previewModal.show();
}
</script>
{% endblock %}
